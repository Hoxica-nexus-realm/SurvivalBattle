package ham_sandwitch.plugin.survivalbattle.game;

import org.bukkit.Bukkit;
import org.bukkit.boss.BarColor;
import org.bukkit.boss.BarStyle;
import org.bukkit.boss.BossBar;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scheduler.BukkitTask;

public class GameTimer {
    
    private final JavaPlugin plugin;
    private final GameManager gameManager;
    private final BossBar bossBar;
    private final java.util.Set<java.util.UUID> bossBarPlayerIds = new java.util.HashSet<>();
    
    private BukkitTask timerTask;
    private int timeLeft;
    private int countdownTimeLeft;

    // ボーダー縮小表示用
    private int borderShrinkTimeLeft = 0;
    private int borderShrinkDuration = 0;
    
    public GameTimer(JavaPlugin plugin, GameManager gameManager) {
        this.plugin = plugin;
        this.gameManager = gameManager;
        this.bossBar = Bukkit.createBossBar("Survival Battle - IDLE", BarColor.BLUE, BarStyle.SEGMENTED_10);
        this.bossBar.setVisible(false);
    }
    
    public static class GameTime {
        public int minutes;
        public int seconds;
        
        public GameTime(int totalSeconds) {
            this.minutes = totalSeconds / 60;
            this.seconds = totalSeconds % 60;
        }
    }
    
    /**
     * タイマーを開始
     */
    public void start() {
        // 既に実行中のタスクをキャンセル
        if (timerTask != null) {
            timerTask.cancel();
            timerTask = null;
        }
        
        bossBar.setVisible(true);
        updateBossBarPlayers();
        
        // タイマータスク開始
        timerTask = Bukkit.getScheduler().runTaskTimer(plugin, () -> {
            GameManager.Phase phase = gameManager.getCurrentPhase();
            
            if (phase == GameManager.Phase.COUNTDOWN) {
                handleCountdown();
            } else if (phase == GameManager.Phase.COLLECTION || phase == GameManager.Phase.PVP) {
                handleGameTime();
            }
            
            // 毎秒 BossBar 表示を更新
            updateBossBarPlayers();

            // 追加: 生存プレイヤーの tab HP 更新（GameManager 側で実装）
            try {
                gameManager.updateTabHpDisplay();
            } catch (Exception ignored) {}
        }, 0L, 20L);  // 即座に開始、20tick(1秒)ごと実行
    }
    
    /**
     * BossBar にプレイヤーを追加
     */
    private void updateBossBarPlayers() {
        try {
            java.util.Set<java.util.UUID> desired = new java.util.HashSet<>();
            for (Player p : gameManager.getPlayersForBossBar()) {
                if (p == null || !p.isOnline()) continue;
                desired.add(p.getUniqueId());
            }

            // Remove players no longer desired
            java.util.Iterator<java.util.UUID> it = bossBarPlayerIds.iterator();
            while (it.hasNext()) {
                java.util.UUID id = it.next();
                if (!desired.contains(id)) {
                    Player pl = Bukkit.getPlayer(id);
                    if (pl != null) {
                        try { bossBar.removePlayer(pl); } catch (Exception ignored) {}
                    }
                    it.remove();
                }
            }

            // Add new players
            for (java.util.UUID id : desired) {
                if (!bossBarPlayerIds.contains(id)) {
                    Player pl = Bukkit.getPlayer(id);
                    if (pl != null && pl.isOnline()) {
                        try { bossBar.addPlayer(pl); bossBarPlayerIds.add(id); } catch (Exception ignored) {}
                    }
                }
            }
        } catch (Exception e) {
            // Fallback to safe behavior
            try {
                bossBar.removeAll();
                bossBarPlayerIds.clear();
            } catch (Exception ignored) {}
        }
    }
    
    /**
     * タイマーを停止
     */
    public void stop() {
        if (timerTask != null) {
            timerTask.cancel();
            timerTask = null;
        }
    }
    
    /**
     * カウントダウンフェーズの処理
     */
    private void handleCountdown() {
        bossBar.setVisible(false);

        countdownTimeLeft--;

        if (countdownTimeLeft <= 0) {
            gameManager.startCollectionPhase();
            gameManager.sendGameMessage("[サバイバルバトロワ] ゲーム開始！");
            playSound(org.bukkit.Sound.ENTITY_ENDER_DRAGON_GROWL);
        } else {
            // 毎秒チャットで通知（参加者のみ）
            gameManager.sendGameMessage("[サバイバルバトロワ] ゲーム開始まで " + countdownTimeLeft + "秒");
            if (countdownTimeLeft <= 5) {
                playSound(org.bukkit.Sound.BLOCK_NOTE_BLOCK_HAT);
            }
        }
    }
    
    /**
     * COLLECTION/PVPフェーズの処理
     */
    private void handleGameTime() {
        // 大切: borderShrinkTimeLeft があればそれを優先表示しつつ timeLeft も減らす
        if (borderShrinkTimeLeft > 0 && gameManager.getCurrentPhase() == GameManager.Phase.PVP) {
            borderShrinkTimeLeft--;
            double progress = Math.max(0.0, Math.min(1.0, (double) borderShrinkTimeLeft / Math.max(1, borderShrinkDuration)));
            bossBar.setProgress(progress);
            
            int minutes = borderShrinkTimeLeft / 60;
            int seconds = borderShrinkTimeLeft % 60;
            bossBar.setTitle("§cワールドボーダー縮小まで §e" + minutes + ":" + String.format("%02d", seconds));
            bossBar.setColor(BarColor.RED);

            // なお、通常の PvP 残り時間も減らす（プレイヤーに合計時間を示すため）
            timeLeft--;
            
            if (borderShrinkTimeLeft <= 0) {
                // 縮小終了時は特別効果音
                playSound(org.bukkit.Sound.ENTITY_WITHER_SPAWN);
                // 続行して通常の PvP ボスバー表示に戻る（次 tick）
            }
            // 他の通知は下段の通常処理に委ねる（return して二重処理を防ぐ）
            return;
        }

        // 既存の timeLeft 処理（COLLECTION/PVP 両方で動作）
        timeLeft--;
        
        GameManager.Phase phase = gameManager.getCurrentPhase();
        int initialTime = phase == GameManager.Phase.COLLECTION 
            ? plugin.getConfig().getInt("game.collection_time_seconds", 600)
            : plugin.getConfig().getInt("game.pvp_time_seconds", 900);
        
        double progress = Math.max(0.0, Math.min(1.0, (double) timeLeft / initialTime));
        bossBar.setProgress(progress);
        
        GameTime gameTime = new GameTime(timeLeft);
        String phaseColor = phase == GameManager.Phase.COLLECTION ? "§a" : "§c";
        String phaseName = phase == GameManager.Phase.COLLECTION ? "資源収集" : "PVP";
        bossBar.setTitle(phaseColor + phaseName + " §f- §e" + gameTime.minutes + ":" + String.format("%02d", gameTime.seconds));
        bossBar.setColor(phase == GameManager.Phase.COLLECTION ? BarColor.GREEN : BarColor.RED);
        
        if (timeLeft <= 0) {
            if (phase == GameManager.Phase.COLLECTION) {
                gameManager.startPvpPhase();
                gameManager.sendGameMessage("[サバイバルバトロワ] PVPフェーズ開始！");
                playSound(org.bukkit.Sound.ENTITY_WITHER_SPAWN);
            } else {
                gameManager.sendGameMessage("[サバイバルバトロワ] 時間切れです。ゲームを終了します。");
                gameManager.finalizeGameAndTeleportAll(null);
            }
            return;
        }
        
        if (phase == GameManager.Phase.COLLECTION && timeLeft == 60) {
            gameManager.sendGameMessage("[サバイバルバトロワ] フェーズ終了まで残り1分");
            playSound(org.bukkit.Sound.BLOCK_NOTE_BLOCK_PLING);
        }
        
        if (timeLeft % 300 == 0 && timeLeft > 0) {
            int remainingMinutes = timeLeft / 60;
            gameManager.sendGameMessage("[サバイバルバトロワ] 残り時間: " + remainingMinutes + "分");
        }
        
        if (phase == GameManager.Phase.PVP && timeLeft == 60) {
            gameManager.sendGameMessage("[サバイバルバトロワ] 残り時間1分！");
        }
    }
    
    /**
     * 効果音を全プレイヤーに再生
     */
    private void playSound(org.bukkit.Sound sound) {
        for (Player p : gameManager.getPlayersForBossBar()) {
            p.playSound(p.getLocation(), sound, 1.0f, 1.0f);
        }
    }
    
    public void setCountdownTime(int seconds) {
        this.countdownTimeLeft = seconds;
    }
    
    public void setGameTime(int seconds) {
        this.timeLeft = seconds;
    }

    public void setBorderShrinkDuration(int seconds) {
        this.borderShrinkDuration = Math.max(0, seconds);
        this.borderShrinkTimeLeft = this.borderShrinkDuration;
    }

    // reset shrink info when stopping or starting new phases
    public void resetBorderShrinkInfo() {
        this.borderShrinkDuration = 0;
        this.borderShrinkTimeLeft = 0;
    }
    
    public BossBar getBossBar() {
        return bossBar;
    }

    // 追加: BossBar を完全にクリア
    public void clearBossBar() {
        try {
            bossBar.removeAll();
            bossBar.setVisible(false);
        } catch (Exception ignored) {}
    }
    
    public void updateBossBar(String title, BarColor color, boolean visible) {
        bossBar.setTitle(title);
        bossBar.setColor(color);
        bossBar.setVisible(visible);
    }
    
    public GameTime getRemainingTime() {
        GameManager.Phase phase = gameManager.getCurrentPhase();
        if (phase == GameManager.Phase.COUNTDOWN) {
            return new GameTime(countdownTimeLeft);
        } else if (phase == GameManager.Phase.COLLECTION || phase == GameManager.Phase.PVP) {
            return new GameTime(timeLeft);
        }
        return new GameTime(0);
    }

    // 追加: フォーマット済みの残り時間
    public String getFormattedRemainingTime() {
        GameTime rt = getRemainingTime();
        return rt.minutes + ":" + String.format("%02d", rt.seconds);
    }

    // 追加: 縮小がアクティブかどうか
    public boolean isShrinkActive() {
        return borderShrinkTimeLeft > 0;
    }

    // 追加: フォーマット済みの縮小残り時間
    public String getFormattedShrinkTimeLeft() {
        int sec = Math.max(0, borderShrinkTimeLeft);
        int m = sec / 60;
        int s = sec % 60;
        return m + ":" + String.format("%02d", s);
    }

    // デバッグ: 現在フェーズの残りを1秒にする
    public void debugSkip() {
        GameManager.Phase phase = gameManager.getCurrentPhase();
        if (phase == GameManager.Phase.COUNTDOWN) {
            this.countdownTimeLeft = 1;
        } else if (phase == GameManager.Phase.COLLECTION || phase == GameManager.Phase.PVP) {
            this.timeLeft = 1;
        }
    }
}
