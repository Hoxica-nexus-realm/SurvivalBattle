package ham_sandwitch.plugin.survivalbattle.game;

import java.util.ArrayList;
import java.util.EnumMap;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.World;
import org.bukkit.WorldBorder;
import org.bukkit.boss.BarColor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.plugin.java.JavaPlugin;

import ham_sandwitch.plugin.survivalbattle.Main;

public class GameManager {

    private final JavaPlugin plugin;
    private final Location lobbyLocation;
    private final Location waitingLocation;
    private final WorldManager worldManager;
    private final PlayerSetupManager playerSetupManager;
    private final GameTimer gameTimer;

    private Phase currentPhase = Phase.IDLE;
    private final TeamManager teamManager;
    private final Set<UUID> idleSpectators = new LinkedHashSet<>();
    private final Map<UUID, PlayerStats> playerStats = new HashMap<>();
    private final DebugManager debugManager;
    private int fakePlayers = 0;
    private final PlayerStateManager playerStateManager;

    // GUI ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè­˜åˆ¥ç”¨ï¼‰
    private static final String TEAM_GUI_TITLE = ChatColor.AQUA + "ãƒãƒ¼ãƒ ã‚’é¸ã¶";

    public GameManager(JavaPlugin plugin, Location lobbyLocation, Location waitingLocation) {
        this.plugin = plugin;
        this.lobbyLocation = lobbyLocation;
        this.waitingLocation = waitingLocation;
        this.worldManager = new WorldManager(plugin);
        this.playerSetupManager = new PlayerSetupManager(plugin, lobbyLocation, waitingLocation);
        this.gameTimer = new GameTimer(plugin, this);

        this.debugManager = new DebugManager(plugin);
        this.teamManager = new TeamManager(plugin);
        this.playerStateManager = new PlayerStateManager(plugin);

        // éå»ã®UUIDã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰
        loadPlayerStats();
    }

    // Player state saved/restore moved to PlayerStateManager

    // --- Getters for delegated event handler ---
    public PlayerSetupManager getPlayerSetupManager() { return playerSetupManager; }
    public Set<UUID> getAlivePlayers() { return teamManager.getAlivePlayers(); }
    public Set<UUID> getIdleSpectators() { return idleSpectators; }
    public Map<UUID, Team> getPlayerTeams() { return teamManager.getPlayerTeams(); }
    public EnumMap<Team, Set<UUID>> getTeamMembers() { return teamManager.getTeamMembers(); }
    public Location getWaitingLocation() { return waitingLocation; }
    public Location getLobbyLocation() { return lobbyLocation; }
    public WorldManager getWorldManagerPublic() { return worldManager; }
    public JavaPlugin getPlugin() { return plugin; }
    public String getTeamGuiTitle() { return TEAM_GUI_TITLE; }
    public Phase getPhasePublic() { return currentPhase; }

    // Expose determineWinner for event logic
    public Team determineWinnerPublic() { return determineWinner(); }

    // Save stats asynchronously
    public void savePlayerStatsAsync() {
        Bukkit.getScheduler().runTaskAsynchronously(plugin, this::savePlayerStats);
    }

    /**
     * ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’å–å¾—
     */
    public Phase getPhase() {
        return currentPhase;
    }

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…æ©Ÿå ´ã¸ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
     */
    public void teleportToWaiting(Player p) {
        if (p == null || !p.isOnline()) return;
        p.teleport(waitingLocation);
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒãªã‘ã‚Œã°ä¿å­˜ã—ã¦ãŠãï¼ˆé‡è¤‡ä¿å­˜ã‚’é¿ã‘ã‚‹ï¼‰
        try {
            if (!playerStateManager.hasSavedState(p.getUniqueId())) {
                playerStateManager.savePreMatchState(p);
            }
        } catch (Exception ignored) {}
        // å¾…æ©Ÿå ´ç”¨ã®è£…å‚™/çŠ¶æ…‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        playerSetupManager.setupWaitingPlayer(p);
        p.sendMessage(ChatColor.GREEN + "âœ… å¾…æ©Ÿå ´ã«ç§»å‹•ã—ã¾ã—ãŸã€‚");
    }

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ­ãƒ“ãƒ¼ã¸ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
     */
    public void teleportToLobby(Player p) {
        if (p == null || !p.isOnline()) return;
        p.teleport(lobbyLocation);
        // ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹éš›ã€è©¦åˆå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å¾©å…ƒã™ã‚‹
        if (playerStateManager.hasSavedState(p.getUniqueId())) {
            try {
                playerStateManager.restorePostMatchState(p);
                p.sendMessage(ChatColor.GREEN + "âœ… ãƒ­ãƒ“ãƒ¼ã«ç§»å‹•ã—ã¾ã—ãŸï¼ˆè©¦åˆå‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼‰ã€‚");
                return;
            } catch (Exception e) {
                plugin.getLogger().warning("Failed to restore state on lobby teleport for " + p.getName() + ": " + e.getMessage());
            }
        }
        p.sendMessage(ChatColor.GREEN + "âœ… ãƒ­ãƒ“ãƒ¼ã«ç§»å‹•ã—ã¾ã—ãŸã€‚");
    }

    public enum Phase {
        IDLE, COUNTDOWN, COLLECTION, PVP, END
    }

    public enum Team {
        RED(ChatColor.RED + "Red Team"), BLUE(ChatColor.BLUE + "Blue Team");

        private final String displayName;

        Team(String displayName) {
            this.displayName = displayName;
        }

        public String getDisplayName() {
            return displayName;
        }
    }

    // ã‚²ãƒ¼ãƒ å‚åŠ è€…ï¼ˆBossBar/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾è±¡ï¼‰ã‚’è¿”ã™
    public java.util.List<Player> getPlayersForBossBar() {
        java.util.List<Player> result = new java.util.ArrayList<>();
        switch (currentPhase) {
            case COUNTDOWN:
                World waitingWorld = waitingLocation.getWorld();
                if (waitingWorld != null) {
                    for (Player p : Bukkit.getOnlinePlayers()) {
                        if (p.isOnline() && p.getWorld().equals(waitingWorld)) result.add(p);
                    }
                }
                break;
            case COLLECTION:
            case PVP:
                Set<UUID> participants = teamManager.getAllParticipants();
                for (Player p : Bukkit.getOnlinePlayers()) {
                    if (participants.contains(p.getUniqueId())) result.add(p);
                }
                break;
            default:
                break;
        }
        return result;
    }

    // å‚åŠ è€…ã«ã ã‘ã‚²ãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    public void sendGameMessage(String msg) {
        for (Player p : getPlayersForBossBar()) {
            p.sendMessage(msg);
        }
    }

    // ç®¡ç†è€…ï¼ˆOPï¼‰ã¨ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œè€…ã«ã®ã¿é€šçŸ¥ã‚’é€ã‚‹ã€‚retryHint=true ãªã‚‰å†è©¦è¡Œã®æ¡ˆå†…ã‚’å®Ÿè¡Œè€…ã«ä»˜è¨˜
    public void sendAdminNotice(CommandSender origin, String msg, boolean retryHint) {
        // å®Ÿè¡Œè€…
        if (origin != null) {
            origin.sendMessage(msg);
            if (retryHint) {
                origin.sendMessage(ChatColor.GRAY + "åŒæ§˜ã®æ“ä½œã‚’ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚æ”¹å–„ã—ãªã„å ´åˆã¯ç®¡ç†è€…ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚");
            }
        }
        // OP å…¨å“¡
        for (Player op : Bukkit.getOnlinePlayers()) {
            if (op.isOp()) {
                op.sendMessage(msg);
            }
        }
        // ãƒ­ã‚°ã«ã‚‚æ®‹ã™
        plugin.getLogger().info(ChatColor.stripColor(msg));
    }

    /**
     * ãƒ­ãƒ“ãƒ¼ã«ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
     */
    public void joinLobby(Player p) {
        if (p == null || !p.isOnline()) return;

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…æ©Ÿå ´æ‰€ã¸ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
        p.teleport(waitingLocation);

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        playerSetupManager.setupWaitingPlayer(p);

        // â˜… 2. ä¿®æ­£: å¾…æ©Ÿãƒ¯ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯
        Main mainInstance = (Main) plugin;
        String missingWorldName = mainInstance.getMissingWaitingWorldName();

        if (missingWorldName != null) {
            // å¾…æ©Ÿãƒ¯ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã‹ã£ãŸå ´åˆã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            p.sendMessage(
                    ChatColor.RED + "Â§l[è­¦å‘Š] " + ChatColor.RED + missingWorldName +
                            ChatColor.YELLOW + "ãŒå­˜åœ¨ã—ãªã‹ã£ãŸãŸã‚" +
                            ChatColor.RED + "ãƒ­ãƒ“ãƒ¼ã«è»¢é€ã•ã‚Œã¾ã—ãŸ"
            );
            // è»¢é€ã•ã‚ŒãŸåº§æ¨™ã‚’è¡¨ç¤º
            p.sendMessage(ChatColor.GRAY + "è¨­å®šã•ã‚ŒãŸå¾…æ©Ÿå ´æ‰€ã®åº§æ¨™ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™: (" + (int)waitingLocation.getX() + ", " + (int)waitingLocation.getY() + ", " + (int)waitingLocation.getZ() + ")");
        } else {
            // æ­£å¸¸ã«å¾…æ©Ÿå ´æ‰€ã«è»¢é€ã•ã‚ŒãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            p.sendMessage(ChatColor.GREEN + "âœ… å¾…æ©Ÿå ´ã«å‚åŠ ã—ã¾ã—ãŸã€‚");
        }
    }

    /**
     * ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
     */
    public boolean startGame() {
        return startGame(null);
    }

    // Overload: ã‚³ãƒãƒ³ãƒ‰é€ä¿¡è€…ã‚’å—ã‘å–ã‚‹ç‰ˆï¼ˆå¾Œæ–¹äº’æ›ï¼‰
    public boolean startGame(CommandSender sender) {
        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œé€šçŸ¥ï¼ˆç®¡ç†è€…ãƒ»å®Ÿè¡Œè€…å‘ã‘ï¼‰
        sendAdminNotice(sender, ChatColor.YELLOW + "[é‹å–¶] ã‚²ãƒ¼ãƒ é–‹å§‹æº–å‚™ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚", false);

        if (currentPhase != Phase.IDLE) {
            sendAdminNotice(sender, ChatColor.RED + "âŒ ã‚²ãƒ¼ãƒ ã¯æ—¢ã«é€²è¡Œä¸­ã§ã™ã€‚ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º: " + currentPhase, true);
            return false;
        }

        int minPlayers = plugin.getConfig().getInt("settings.min_players", 2);
        int online = Bukkit.getOnlinePlayers().size();
        if ((online + fakePlayers) < minPlayers && !debugManager.isDebugMode()) {
            sendAdminNotice(sender, ChatColor.RED + "âŒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚(æœ€ä½" + minPlayers + "äººå¿…è¦ / ãƒ€ãƒŸãƒ¼:" + fakePlayers + ")", true);
            return false;
        }

        if (!worldManager.createBattleWorld()) {
            sendAdminNotice(sender, ChatColor.RED + "âŒ ãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
            return false;
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºã‚’ COUNTDOWN ã«è¨­å®šã—ã€ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
        setPhase(Phase.COUNTDOWN);
        gameTimer.setCountdownTime(plugin.getConfig().getInt("settings.countdown", 10));
        gameTimer.start();

        // é‡è¦: å¾…æ©Ÿå ´ã«ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚’å‚åŠ å¯¾è±¡ã«ã™ã‚‹ãŸã‚ã€
        // ã“ã“ã§ã¯ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç§»å‹•ã•ã›ãªã„ï¼ˆå¹²æ¸‰ã—ãªã„ï¼‰ã€‚

        sendGameMessage("[ã‚µãƒã‚¤ãƒãƒ«ãƒãƒˆãƒ­ãƒ¯] ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚");
        // Discord é€šçŸ¥ï¼ˆæœ‰åŠ¹ãªã‚‰é€ä¿¡ï¼‰
        try {
            Main main = (Main) plugin;
            if (main.getDiscordNotifier() != null) {
                try {
                    main.getDiscordNotifier().sendStartNotification(org.bukkit.ChatColor.stripColor("[ã‚µãƒã‚¤ãƒãƒ«ãƒãƒˆãƒ­ãƒ¯] ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚"));
                } catch (Exception e) {
                    plugin.getLogger().warning("Discord start notify failed: " + e.getMessage());
                }
            }
        } catch (Exception ignored) {}
        return true;
    }

    /**
     * ã‚²ãƒ¼ãƒ ã‚’å¼·åˆ¶çµ‚äº†
     */
    public boolean stopGame() {
        if (currentPhase == Phase.IDLE || currentPhase == Phase.END) {
            Bukkit.broadcastMessage(ChatColor.RED + "âŒ ã‚²ãƒ¼ãƒ ã¯é€²è¡Œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            return false;
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
        gameTimer.stop();

        // å‚åŠ è€…ï¼ˆãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã®ã¿ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã™
        World battleWorld = worldManager.getBattleWorld();
        if (battleWorld != null) {
            for (Player p : Bukkit.getOnlinePlayers()) {
                if (p.isOnline() && p.getWorld().equals(battleWorld)) {
                    p.teleport(lobbyLocation);
                    playerSetupManager.setupLobbyPlayer(p);
                }
            }
        }

        // å…ƒå‚åŠ è€…ã‚’ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ã«ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ã¿ï¼‰
        for (Team t : Team.values()) {
            for (UUID id : teamManager.getTeamMembers().getOrDefault(t, java.util.Collections.emptySet())) {
                Player op = Bukkit.getPlayer(id);
                if (op != null && op.isOnline()) {
                    op.setGameMode(GameMode.ADVENTURE);
                }
            }
        }

        // ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
        worldManager.deleteBattleWorld();

        // ãƒ•ã‚§ãƒ¼ã‚ºã‚’ END ã«è¨­å®š (å†…éƒ¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨)
        setPhase(Phase.END);
            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetGameState();

        sendGameMessage(ChatColor.RED + "ğŸ›‘ ã‚²ãƒ¼ãƒ ãŒå¼·åˆ¶çµ‚äº†ã•ã‚Œã¾ã—ãŸã€‚");
        return true;
    }

    // Overload: ã‚³ãƒãƒ³ãƒ‰é€ä¿¡è€…ã‚’å—ã‘å–ã‚‹ç‰ˆï¼ˆå¾Œæ–¹äº’æ›ï¼‰
    public boolean stopGame(CommandSender sender) {
        return stopGame();
    }

    /**
     * ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
     */
    private void resetGameState() {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼/ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
        teamManager.clearAll();
        idleSpectators.clear();

        // ãƒ•ã‚§ãƒ¼ã‚ºã‚’ IDLE ã«æˆ»ã™
        setPhase(Phase.IDLE);
    }

    /**
     * ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¨­å®š
     */
    public void setPhase(Phase newPhase) {
        if (currentPhase == newPhase) return;

        plugin.getLogger().info("Phase changed from " + currentPhase + " to " + newPhase);
        this.currentPhase = newPhase;

        // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®å‡¦ç†
        switch (newPhase) {
            case COUNTDOWN:
                // Countdown to Collection
                break;
            case COLLECTION:
                // Teleport players to battle world
                teleportPlayersToBattle();
                // Setup World Border for Collection
                worldManager.setupCollectionPhaseBorder();
                // Setup game timer for Collection
                gameTimer.setGameTime(plugin.getConfig().getInt("game.collection_time_seconds", 600));
                gameTimer.updateBossBar(ChatColor.GREEN + "åé›†ãƒ•ã‚§ãƒ¼ã‚º", BarColor.GREEN, true);
                break;
            case PVP:
                worldManager.setupPVPPhaseBorder();
                gameTimer.setGameTime(plugin.getConfig().getInt("game.pvp_time_seconds", 300));
                gameTimer.setBorderShrinkDuration(plugin.getConfig().getInt("game.border_shrink_duration_seconds", 180));
                gameTimer.updateBossBar(ChatColor.RED + "PVPãƒ•ã‚§ãƒ¼ã‚º", BarColor.RED, true);
                break;
            case END:
                // Stop timer and announce winner
                gameTimer.stop();
                worldManager.deleteBattleWorld();
                // å‹åˆ©å‡¦ç†ã¯åˆ¥ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡Œã†
                break;
            case IDLE:
                // Clean up any remaining boss bars, etc.
                gameTimer.updateBossBar("Survival Battle - IDLE", BarColor.BLUE, false);
                gameTimer.resetBorderShrinkInfo();
                // 3ç§’å¾Œã‚‚IDLEãªã‚‰BossBarã‚’å®Œå…¨ã«é™¤å»
                Bukkit.getScheduler().runTaskLater(plugin, () -> {
                    if (currentPhase == Phase.IDLE) {
                        try { gameTimer.clearBossBar(); } catch (Exception ignored) {}
                    }
                }, 60L);
                break;
        }
    }

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
     */
    private void teleportPlayersToBattle() {
        World battleWorld = worldManager.getBattleWorld();
        if (battleWorld == null) {
            sendGameMessage(ChatColor.RED + "âŒ ãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ãŒæº–å‚™ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            stopGame();
            return;
        }

        // å‚åŠ ã—ã¦ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒªã‚¹ãƒˆåŒ–
        List<Player> joinablePlayers = new ArrayList<>();
        for (Player p : Bukkit.getOnlinePlayers()) {
            if (p.getWorld().equals(waitingLocation.getWorld())) {
                joinablePlayers.add(p);
            }
        }

        int minPlayers = plugin.getConfig().getInt("settings.min_players", 2);
        if ((joinablePlayers.size() + fakePlayers) < minPlayers) {
            for (Player p : joinablePlayers) {
                p.sendMessage(ChatColor.RED + "âŒ å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚(å¿…è¦:" + minPlayers + " / ãƒ€ãƒŸãƒ¼:" + fakePlayers + ")");
            }
            stopGame();
            return;
        }

        // ãƒãƒ¼ãƒ åˆ†ã‘
        teamManager.assignTeams(joinablePlayers, fakePlayers);

        // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
        for (Player p : joinablePlayers) {
            if (p.isOnline()) {
                Location safeLoc = TeleportUtil.findSafeLocation(battleWorld.getSpawnLocation());
                p.teleport(safeLoc);
                // save pre-match inventory/state before clearing/giving match gear
                playerStateManager.savePreMatchState(p);
                playerSetupManager.setupBattlePlayer(p);
                teamManager.addAlive(p.getUniqueId());

                Team team = teamManager.getTeam(p.getUniqueId());
                p.sendMessage(ChatColor.AQUA + "ãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«è»¢é€ã•ã‚Œã¾ã—ãŸã€‚");
                if (team != null) {
                    p.sendMessage(ChatColor.AQUA + "ã‚ãªãŸã¯ " + team.getDisplayName() + ChatColor.AQUA + " ã§ã™ã€‚");
                }

                // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã®5ç§’å›å¾©ç³»ãƒãƒ•
                playerSetupManager.applyStartBuffs(p, 5);
            }
        }

        // è¦³æˆ¦è€…ãƒ¢ãƒ¼ãƒ‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãƒ†ãƒ¬ãƒãƒ¼ãƒˆã—ãªã„
    }

    // ãƒãƒ¼ãƒ é¸æŠGUIã‚’é–‹ãï¼ˆå¾…æ©Ÿå ´é™å®šï¼‰
    private void openTeamSelectGui(Player p) {
        if (p == null || !p.isOnline()) return;
        Inventory inv = Bukkit.createInventory(p, 9, TEAM_GUI_TITLE);
        // RED ãƒœã‚¿ãƒ³
        ItemStack red = new ItemStack(Material.RED_WOOL);
        ItemMeta rm = red.getItemMeta();
        if (rm != null) {
            rm.setDisplayName(ChatColor.RED + "Red Team");
            int count = teamManager.getTeamMembers().get(Team.RED).size();
            rm.setLore(java.util.Collections.singletonList(ChatColor.GRAY + "äººæ•°: " + count));
            red.setItemMeta(rm);
        }
        // BLUE ãƒœã‚¿ãƒ³
        ItemStack blue = new ItemStack(Material.BLUE_WOOL);
        ItemMeta bm = blue.getItemMeta();
        if (bm != null) {
            bm.setDisplayName(ChatColor.BLUE + "Blue Team");
            int count = teamManager.getTeamMembers().get(Team.BLUE).size();
            bm.setLore(java.util.Collections.singletonList(ChatColor.GRAY + "äººæ•°: " + count));
            blue.setItemMeta(bm);
        }
        inv.setItem(2, red);
        inv.setItem(6, blue);
        p.openInventory(inv);
    }

    // GUI ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    private void handleTeamSelectClick(Player p, ItemStack clicked) {
        if (clicked == null || clicked.getType() == Material.AIR) return;
        ItemMeta meta = clicked.getItemMeta();
        String name = meta != null ? meta.getDisplayName() : "";
        Team target = null;
        if (name.contains("Red")) target = Team.RED;
        if (name.contains("Blue")) target = Team.BLUE;
        if (target == null) return;

        // COUNTDOWN ä»¥é™ã¯å¤‰æ›´ä¸å¯ã«ã™ã‚‹å ´åˆã¯ã“ã“ã§åˆ¶å¾¡ï¼ˆä»Šå›ã¯å¾…æ©Ÿå ´åˆ©ç”¨æƒ³å®šï¼‰

        setPlayerTeam(p, target);
        p.sendMessage(ChatColor.AQUA + "ãƒãƒ¼ãƒ ã‚’ " + target.getDisplayName() + ChatColor.AQUA + " ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚");
        // OP ã¸å‚åŠ é€šçŸ¥
        String notice = ChatColor.YELLOW + "[é‹å–¶] " + p.getName() + ChatColor.RESET + " ãŒ " + target.getDisplayName() + ChatColor.RESET + " ã«å‚åŠ ã—ã¾ã—ãŸ";
        sendAdminNotice(null, notice, false);
        // å†æç”»
        Bukkit.getScheduler().runTask(plugin, () -> openTeamSelectGui(p));
    }

    private void setPlayerTeam(Player p, Team team) {
        teamManager.setPlayerTeam(p, team);
    }

    /**
     * å‚åŠ å¯èƒ½ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒãƒ¼ãƒ åˆ†ã‘
     */
    // Team assignment moved to TeamManager

    /**
     * ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
     */
    public void endGame(Team winner) {
        // Stop timer immediately and perform teleport/cleanup before deleting the world
        gameTimer.stop();

        String message;
        if (winner != null) {
            message = ChatColor.GOLD + "ğŸ† " + winner.getDisplayName() + ChatColor.GOLD + " ã®å‹åˆ©ï¼";
            // çµ±è¨ˆæƒ…å ±æ›´æ–°
            for (UUID uuid : teamManager.getTeamMembers().get(winner)) {
                getPlayerStats(uuid).incrementWins();
            }
            // æ•—åŒ—çµ±è¨ˆæƒ…å ±æ›´æ–°
            for (Team team : Team.values()) {
                if (team != winner) {
                    for (UUID uuid : teamManager.getTeamMembers().get(team)) {
                        getPlayerStats(uuid).incrementLosses();
                    }
                }
            }
        } else {
            message = ChatColor.YELLOW + "å¼•ãåˆ†ã‘ã§ã™ã€‚";
            // å¼•ãåˆ†ã‘æ™‚ã¯èª°ã‚‚å‹åˆ©/æ•—åŒ—ã«ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
        }

        sendGameMessage(ChatColor.AQUA + "â”â”â”â”â”â” ã‚²ãƒ¼ãƒ çµ‚äº† â”â”â”â”â”â”");
        sendGameMessage(message);
        sendGameMessage(ChatColor.AQUA + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

        // Discord é€šçŸ¥ï¼ˆæœ‰åŠ¹ãªã‚‰é€ä¿¡ï¼‰
        try {
            Main main = (Main) plugin;
            if (main.getDiscordNotifier() != null) {
                try {
                    main.getDiscordNotifier().sendEndNotification(org.bukkit.ChatColor.stripColor(message));
                } catch (Exception e) {
                    plugin.getLogger().warning("Discord end notify failed: " + e.getMessage());
                }
            }
        } catch (Exception ignored) {}

        // Run teleport and cleanup on main thread immediately to ensure players are returned
        Bukkit.getScheduler().runTask(plugin, () -> {
            World battleWorld = worldManager.getBattleWorld();

            // 1) Teleport all known participants (team members) back to lobby and restore/set state
            for (UUID uuid : teamManager.getAllParticipants()) {
                Player p = Bukkit.getPlayer(uuid);
                if (p != null && p.isOnline()) {
                    try {
                        p.teleport(lobbyLocation);
                        if (playerStateManager.hasSavedState(p.getUniqueId())) {
                            playerStateManager.restorePostMatchState(p);
                            p.sendMessage(ChatColor.GREEN + "ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã—ãŸï¼ˆè©¦åˆå‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼‰ã€‚");
                        } else {
                            playerSetupManager.setupLobbyPlayer(p);
                            p.sendMessage(ChatColor.GREEN + "ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
                        }
                        p.setGameMode(GameMode.ADVENTURE);
                    } catch (Exception e) {
                        plugin.getLogger().warning("Failed to teleport/restore participant " + uuid + ": " + e.getMessage());
                    }
                }
            }

            // 2) Additionally, ensure any online player currently in the battle world is returned
            if (battleWorld != null) {
                for (Player p : Bukkit.getOnlinePlayers()) {
                    if (p != null && p.isOnline() && p.getWorld().equals(battleWorld)) {
                        try {
                            p.teleport(lobbyLocation);
                            if (playerStateManager.hasSavedState(p.getUniqueId())) {
                                playerStateManager.restorePostMatchState(p);
                                p.sendMessage(ChatColor.GREEN + "ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã—ãŸï¼ˆè©¦åˆå‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼‰ã€‚");
                            } else {
                                playerSetupManager.setupLobbyPlayer(p);
                                p.sendMessage(ChatColor.GREEN + "ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
                            }
                            p.setGameMode(GameMode.ADVENTURE);
                        } catch (Exception e) {
                            plugin.getLogger().warning("Failed to teleport player in battle world: " + e.getMessage());
                        }
                    }
                }
            }

            // 3) Ensure all participants are set to ADVENTURE mode (covers offline->online inconsistencies)
            for (Team t : Team.values()) {
                for (UUID id : teamManager.getTeamMembers().getOrDefault(t, java.util.Collections.emptySet())) {
                    Player op = Bukkit.getPlayer(id);
                    if (op != null && op.isOnline()) {
                        try { op.setGameMode(GameMode.ADVENTURE); } catch (Exception ignored) {}
                    }
                }
            }

            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetGameState();

            // ãƒ•ã‚§ãƒ¼ã‚ºã‚’ END ã«è¨­å®šã—ã¦ãƒ¯ãƒ¼ãƒ«ãƒ‰å‰Šé™¤ç­‰ã®å¾Œå‡¦ç†ã‚’è¡Œã†
            setPhase(Phase.END);

            // çµ±è¨ˆæƒ…å ±ã‚’ä¿å­˜
            savePlayerStats();
        });
    }

    /**
     * æ™‚é–“åˆ‡ã‚Œå‡¦ç†
     */
    public void onTimeUp() {
        switch (currentPhase) {
            case COUNTDOWN:
                setPhase(Phase.COLLECTION);
                gameTimer.start(); // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
                break;
            case COLLECTION:
                // åé›†ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº† -> PVPãƒ•ã‚§ãƒ¼ã‚ºã¸
                setPhase(Phase.PVP);
                gameTimer.start(); // PVPãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
                break;
            case PVP:
                // PVPãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº† -> å‹æ•—åˆ¤å®š
                Team winner = determineWinner();
                endGame(winner);
                break;
            default:
                break;
        }
    }

    /**
     * ç”Ÿå­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã‹ã‚‰å‹è€…ã‚’æ±ºå®š
     */
    private Team determineWinner() {
        return teamManager.determineWinner();
    }

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ­»äº¡å‡¦ç†
     */
    // Event handlers have been moved to GameEventListener to reduce GameManager responsibilities.

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---

    /**
     * ã‚²ãƒ¼ãƒ çŠ¶æ…‹è¡¨ç¤º
     */
    public String getGameStatus(CommandSender sender) {
        StringBuilder sb = new StringBuilder();
        sb.append(ChatColor.BLUE).append("â”â”â”â”â” SurvivalBattle çŠ¶æ…‹ â”â”â”â”â”\n");
        sb.append(ChatColor.AQUA).append("ãƒ•ã‚§ãƒ¼ã‚º: ").append(ChatColor.YELLOW).append(currentPhase).append("\n");
        sb.append(ChatColor.AQUA).append("æ®‹ã‚Šæ™‚é–“: ").append(ChatColor.YELLOW).append(gameTimer.getFormattedRemainingTime()).append("\n");
        sb.append(ChatColor.AQUA).append("ç”Ÿå­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ").append(ChatColor.YELLOW).append(teamManager.getAlivePlayers().size()).append(ChatColor.AQUA).append("äºº\n");

        int redAlive = (int) teamManager.getTeamMembers().getOrDefault(Team.RED, new HashSet<>()).stream().filter(teamManager.getAlivePlayers()::contains).count();
        int blueAlive = (int) teamManager.getTeamMembers().getOrDefault(Team.BLUE, new HashSet<>()).stream().filter(teamManager.getAlivePlayers()::contains).count();

        if (redAlive > 0 || blueAlive > 0) {
            sb.append(ChatColor.RED).append(Team.RED.getDisplayName()).append("ç”Ÿå­˜: ").append(ChatColor.RED).append(redAlive).append("äºº\n");
            sb.append(ChatColor.BLUE).append(Team.BLUE.getDisplayName()).append("ç”Ÿå­˜: ").append(ChatColor.BLUE).append(blueAlive).append("äºº\n");
        }

        World battleWorld = worldManager.getBattleWorld();
        if (battleWorld != null) {
            WorldBorder wb = battleWorld.getWorldBorder();
            sb.append(ChatColor.AQUA).append("ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒ€ãƒ¼: ").append(ChatColor.YELLOW).append((int) wb.getSize() / 2).append("ãƒ–ãƒ­ãƒƒã‚¯\n");
            if (gameTimer.isShrinkActive()) {
                sb.append(ChatColor.AQUA).append("ãƒœãƒ¼ãƒ€ãƒ¼ç¸®å°ä¸­: ").append(ChatColor.YELLOW).append(gameTimer.getFormattedShrinkTimeLeft()).append("\n");
            }
        } else {
            sb.append(ChatColor.AQUA).append("ãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰: ").append(ChatColor.YELLOW).append("æœªä½œæˆ\n");
        }

        sb.append(ChatColor.AQUA).append("ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ").append(debugManager.isDebugMode() ? ChatColor.GREEN + "ON" : ChatColor.RED + "OFF").append("\n");

        sb.append(ChatColor.BLUE).append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        return sb.toString();
    }

    /**
     * çµ±è¨ˆæƒ…å ±å–å¾—
     */
    public PlayerStats getPlayerStats(UUID uuid) {
        return playerStats.computeIfAbsent(uuid, k -> new PlayerStats());
    }

    // --- ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰/ã‚»ãƒ¼ãƒ– ---

    private void loadPlayerStats() {
        // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å‡¦ç† (çœç•¥)
        // config.ymlãªã©ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®š
    }

    private void savePlayerStats() {
        // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±è¨ˆæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹å‡¦ç† (çœç•¥)
        // config.ymlãªã©ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®š
    }

    

    // --- ã‚²ãƒƒã‚¿ãƒ¼/ã‚»ãƒƒã‚¿ãƒ¼ ---

    public Phase getCurrentPhase() {
        return currentPhase;
    }

    public WorldManager getWorldManager() {
        return worldManager;
    }

    public boolean isDebugMode() {
        return debugManager.isDebugMode();
    }

    public void setDebugMode(boolean debugMode) {
        debugManager.setDebugMode(debugMode);
    }

    // å¾Œæ–¹äº’æ›ã®ãŸã‚ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
    public void setDebug(boolean enabled) {
        debugManager.setDebug(enabled);
    }

    public void setLogDebugMode(boolean enabled) {
        debugManager.setLogDebugMode(enabled);
    }

    public void setFakePlayers(int count) {
        this.fakePlayers = Math.max(0, count);
        plugin.getLogger().info("Fake players set to " + this.fakePlayers);
    }

    public int getFakePlayers() {
        return fakePlayers;
    }

    /**
     * Remove a player from team maps and alive set; returns their previous team or null.
     */
    public Team removePlayerFromTeams(UUID uuid) {
        return teamManager.removePlayer(uuid);
    }

    public void cleanup() {
        if (currentPhase != Phase.IDLE) {
            stopGame();
        }
        savePlayerStats();
    }

    // ===== è¿½åŠ : GameTimer ã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤ =====

    /**
     * Tabãƒªã‚¹ãƒˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã«HPã‚’è¡¨ç¤ºï¼ˆè¨­å®šã§æœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
     */
    public void updateTabHpDisplay() {
        boolean enabled = plugin.getConfig().getBoolean("display.tab_hp_enabled", true);
        String format = plugin.getConfig().getString("display.tab_hp_format", "{name} Â§7[{hp}â¤]");
        if (!enabled) return;

        for (Player p : Bukkit.getOnlinePlayers()) {
            try {
                double hp = Math.max(0, Math.min(20.0, p.getHealth()));
                String hearts = String.format("%.0f", hp);
                String name = p.getName();
                String list = format.replace("{name}", name).replace("{hp}", hearts);
                p.setPlayerListName(list);
            } catch (Exception ignored) { }
        }
    }

    /**
     * ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†â†’åé›†ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹
     */
    public void startCollectionPhase() {
        setPhase(Phase.COLLECTION);
        int secs = plugin.getConfig().getInt("game.collection_time_seconds", 600);
        gameTimer.setGameTime(secs);
        sendGameMessage(ChatColor.GREEN + "ğŸª“ è³‡æºåé›†ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ï¼");
    }

    /**
     * åé›†ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†â†’PVPãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹
     */
    public void startPvpPhase() {
        setPhase(Phase.PVP);
        int pvpSecs = plugin.getConfig().getInt("game.pvp_time_seconds", 900);
        int shrinkSecs = plugin.getConfig().getInt("game.border_shrink_duration_seconds", 300);
        double finalSize = plugin.getConfig().getDouble("game.border_final_size", 5.0);
        gameTimer.setGameTime(pvpSecs);
        gameTimer.setBorderShrinkDuration(shrinkSecs);

        // ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒ€ãƒ¼ç¸®å°ã‚’é–‹å§‹ï¼ˆç¾åœ¨ã‚µã‚¤ã‚ºâ†’finalSize ã¸ï¼‰
        World battle = worldManager.getBattleWorld();
        if (battle != null) {
            worldManager.startBorderShrink(finalSize, shrinkSecs);
            // ãƒãƒ¼ãƒ å˜ä½ã§ãƒ©ãƒ³ãƒ€ãƒ åœ°ç‚¹ã«TP
            Map<Team, Location> spawnMap = new EnumMap<>(Team.class);
            boolean teamEnabled = plugin.getConfig().getBoolean("teams.enabled", true);
            int protect = plugin.getConfig().getInt("pvp.random_spawn.spawn_protection_seconds", 3);
            for (Team t : Team.values()) {
                if (!teamEnabled) continue; // å€‹åˆ¥TPã«åˆ‡æ›¿
                spawnMap.put(t, worldManager.findRandomLocationInBorder(30, 64));
            }
            for (Player op : Bukkit.getOnlinePlayers()) {
                UUID id = op.getUniqueId();
                Team t = teamManager.getTeam(id);
                if (t == null) continue; // éå‚åŠ è€…
                Location dest;
                if (teamEnabled) {
                    dest = spawnMap.get(t);
                    if (dest == null) dest = worldManager.findRandomLocationInBorder(30, 64);
                } else {
                    dest = worldManager.findRandomLocationInBorder(30, 64);
                }
                if (dest != null) {
                    op.teleport(dest);
                    playerSetupManager.applySpawnProtection(op, protect);
                }
            }
        }

        sendGameMessage(ChatColor.RED + "âš”ï¸ PVPãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ï¼");
    }

    // ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã‚¹ã‚­ãƒƒãƒ—
    public void debugSkipPhase(CommandSender sender) {
        if (!debugManager.isDebugMode()) {
            if (sender != null) sender.sendMessage(ChatColor.YELLOW + "ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚/sb debug on ã§æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        if (currentPhase == Phase.IDLE) {
            if (sender != null) sender.sendMessage(ChatColor.YELLOW + "IDLEä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã›ã‚“ã€‚");
            return;
        }
        try {
            gameTimer.debugSkip();
            if (sender != null) sender.sendMessage(ChatColor.GREEN + "ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼ˆ1ç§’å¾Œï¼‰ã€‚");
        } catch (Exception e) {
            if (sender != null) sender.sendMessage(ChatColor.RED + "ã‚¹ã‚­ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.getMessage());
        }
    }

    /**
     * ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—å…¨å“¡ã‚’ãƒ­ãƒ“ãƒ¼ã¸é€é‚„ï¼ˆå‹è€…æŒ‡å®šå¯ï¼‰
     */
    public void finalizeGameAndTeleportAll(Team winner) {
        endGame(winner);
    }

    /**
     * SbCommand ã‹ã‚‰å‘¼ã°ã‚Œã‚‹çŠ¶æ…‹è¡¨ç¤ºï¼ˆæ–‡å­—åˆ—ã®ã¿è¿”ã™ï¼‰
     */
    public String getGameStats() {
        StringBuilder sb = new StringBuilder();
        sb.append(ChatColor.BLUE).append("â”â”â”â”â” SurvivalBattle çŠ¶æ…‹ â”â”â”â”â”\n");
        sb.append(ChatColor.AQUA).append("ãƒ•ã‚§ãƒ¼ã‚º: ").append(ChatColor.YELLOW).append(currentPhase).append("\n");
        sb.append(ChatColor.AQUA).append("æ®‹ã‚Šæ™‚é–“: ").append(ChatColor.YELLOW).append(gameTimer.getFormattedRemainingTime()).append("\n");
        sb.append(ChatColor.AQUA).append("ç”Ÿå­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ").append(ChatColor.YELLOW).append(teamManager.getAlivePlayers().size()).append(ChatColor.AQUA).append("äºº\n");

        int redAlive = (int) teamManager.getTeamMembers().getOrDefault(Team.RED, new HashSet<>()).stream().filter(teamManager.getAlivePlayers()::contains).count();
        int blueAlive = (int) teamManager.getTeamMembers().getOrDefault(Team.BLUE, new HashSet<>()).stream().filter(teamManager.getAlivePlayers()::contains).count();
        if (redAlive > 0 || blueAlive > 0) {
            sb.append(ChatColor.RED).append(Team.RED.getDisplayName()).append("ç”Ÿå­˜: ").append(ChatColor.RED).append(redAlive).append("äºº\n");
            sb.append(ChatColor.BLUE).append(Team.BLUE.getDisplayName()).append("ç”Ÿå­˜: ").append(ChatColor.BLUE).append(blueAlive).append("äºº\n");
        }

        World battleWorld = worldManager.getBattleWorld();
        if (battleWorld != null) {
            WorldBorder wb = battleWorld.getWorldBorder();
            sb.append(ChatColor.AQUA).append("ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒ€ãƒ¼: ").append(ChatColor.YELLOW).append((int) wb.getSize() / 2).append("ãƒ–ãƒ­ãƒƒã‚¯\n");
            if (gameTimer.isShrinkActive()) {
                sb.append(ChatColor.AQUA).append("ãƒœãƒ¼ãƒ€ãƒ¼ç¸®å°ä¸­: ").append(ChatColor.YELLOW).append(gameTimer.getFormattedShrinkTimeLeft()).append("\n");
            }
        } else {
            sb.append(ChatColor.AQUA).append("ãƒãƒˆãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰: ").append(ChatColor.YELLOW).append("æœªä½œæˆ\n");
        }

        sb.append(ChatColor.AQUA).append("ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ").append(debugManager.isDebugMode() ? ChatColor.GREEN + "ON" : ChatColor.RED + "OFF").append("\n");
        sb.append(ChatColor.BLUE).append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        return sb.toString();
    }
}