package ham_sandwitch.plugin.survivalbattle.game;

import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.World;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemFlag;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.potion.PotionEffect;
import org.bukkit.potion.PotionEffectType;

import java.util.Collections;
import java.util.List;

public class PlayerSetupManager {
    
    private final JavaPlugin plugin;
    private final Location lobbyLocation;
    private final Location waitingLocation;
    
    public PlayerSetupManager(JavaPlugin plugin, Location lobbyLocation, Location waitingLocation) {
        this.plugin = plugin;
        this.lobbyLocation = lobbyLocation;
        this.waitingLocation = waitingLocation;
    }

    // ゲーム開始時の回復系バフ（5秒など）
    public void applyStartBuffs(Player p, int seconds) {
        if (p == null || !p.isOnline()) return;
        int ticks = Math.max(0, seconds) * 20;
        if (ticks <= 0) return;
        try {
            PotionEffectType regen = PotionEffectType.getByName("REGENERATION");
            PotionEffectType saturation = PotionEffectType.getByName("SATURATION");
            if (regen != null) p.addPotionEffect(new PotionEffect(regen, ticks, 2, false)); // 再生 III 相当
            if (saturation != null) p.addPotionEffect(new PotionEffect(saturation, ticks, 1, false));
        } catch (Exception ignored) {}
    }

    // 追加: バトル参加者としてのセットアップ（GameManager から呼ばれる）
    public void setupBattlePlayer(Player p) {
        setupParticipant(p);
    }

    // 追加: 観戦者セットアップ（簡易版）
    public void setupSpectator(Player p) {
        if (p == null || !p.isOnline()) return;
        resetPlayer(p);
        p.setGameMode(GameMode.SPECTATOR);
        p.sendMessage(ChatColor.GRAY + "観戦モードになりました。");
    }
    
    /**
     * ロビーにいるプレイヤーのセットアップ
     */
    public void setupLobbyPlayer(Player p) {
        if (p == null || !p.isOnline()) return;
        
        resetPlayer(p);
        p.setGameMode(GameMode.ADVENTURE);
    }
    
    /**
     * 待機場にいるプレイヤーのセットアップ
     */
    public void setupWaitingPlayer(Player p) {
        if (p == null || !p.isOnline()) return;
        
        resetPlayer(p);
        p.setGameMode(GameMode.ADVENTURE);
        
        // インベントリを一度クリア
        p.getInventory().clear();
        
        // アイテムを設定
        p.getInventory().setItem(0, createLobbyItem(Material.RED_BED, "§cロビーに戻る", "ロビーにテレポートします"));
        p.getInventory().setItem(4, createLobbyItem(Material.EMERALD, "§aゲーム開始", "ゲームを開始します"));
        p.getInventory().setItem(8, createLobbyItem(Material.ENDER_EYE, "§e観戦モード", "観戦者になります"));

        // 追加: チーム選択アイテム（config の許可があれば）
        boolean allowTeam = plugin.getConfig().getBoolean("teams.allow_selection_in_waiting", true);
        if (allowTeam) {
            p.getInventory().setItem(2, createLobbyItem(Material.CHEST, "§bチーム選択", "クリックでチームメニューを開きます"));
        }
        
        // 複数回同期
        p.updateInventory();
        plugin.getServer().getScheduler().runTaskLater(plugin, p::updateInventory, 2L);
    }
    
    /**
     * 参加者としてセットアップ
     */
    public void setupParticipant(Player p) {
        if (p == null || !p.isOnline()) return;
        
        resetPlayer(p);
        p.setGameMode(GameMode.SURVIVAL);
        
        giveInitialGear(p);
        applyInitialEffects(p);
        
        p.sendMessage("§a§lゲームに参加しました！頑張ってください！");
    }

    // スポーン直後の短時間保護
    public void applySpawnProtection(Player p, int seconds) {
        if (p == null || !p.isOnline()) return;
        int ticks = Math.max(0, seconds) * 20;
        if (ticks <= 0) return;
        try {
            PotionEffectType resist = PotionEffectType.getByName("DAMAGE_RESISTANCE");
            if (resist == null) resist = PotionEffectType.getByName("RESISTANCE");
            PotionEffectType slowFall = PotionEffectType.getByName("SLOW_FALLING");
            if (resist != null) p.addPotionEffect(new PotionEffect(resist, ticks, 2, false));
            if (slowFall != null) p.addPotionEffect(new PotionEffect(slowFall, ticks, 1, false));
        } catch (Exception ignored) {}
    }
    
    /**
     * 観戦者としてセットアップ（IDLE中）
     */
    public void setupIdleSpectator(Player p) {
        if (p == null || !p.isOnline()) return;
        
        resetPlayer(p);
        p.setGameMode(GameMode.ADVENTURE);
        
        p.getInventory().setItem(0, createLobbyItem(Material.RED_BED, "§cロビーに戻る", "ロビーにテレポートします"));
        p.getInventory().setItem(4, createLobbyItem(Material.EMERALD, "§aゲーム開始", "ゲームを開始します"));
        p.getInventory().setItem(8, createLobbyItem(Material.ENDER_EYE, "§e観戦モード解除", "参加者に戻ります"));
        
        p.sendMessage("§7観戦モードになりました。ゲームが開始されるまでお待ちください。");
    }
    
    /**
     * 観戦者としてセットアップ（ゲーム中）
     */
    public void setupGameSpectator(Player p, World battleWorld) {
        if (p == null || !p.isOnline()) return;
        
        resetPlayer(p);
        p.setGameMode(GameMode.SPECTATOR);
        
        if (battleWorld != null) {
            p.teleport(battleWorld.getSpawnLocation());
        }
        
        p.sendMessage("§7あなたは観戦者になりました。");
    }
    
    /**
     * プレイヤーをリセット
     */
    private void resetPlayer(Player p) {
        p.setHealth(p.getMaxHealth());
        p.setFoodLevel(20);
        p.setSaturation(5.0f);
        p.getInventory().clear();
        p.setFlying(false);
        p.setAllowFlight(false);
        p.setFireTicks(0);
        p.getActivePotionEffects().forEach(effect -> p.removePotionEffect(effect.getType()));
        // 追加: tab 表示（player list name）をデフォルトに戻す
        try {
            p.setPlayerListName(null);
        } catch (Exception ignored) {}
    }
    
    /**
     * 初期装備を付与
     */
    private void giveInitialGear(Player p) {
        ConfigurationSection items = plugin.getConfig().getConfigurationSection("items");
        if (items == null) return;
        for (String materialName : items.getKeys(false)) {
            try {
                Material material = Material.matchMaterial(materialName);
                int amount = items.getInt(materialName, 1);
                if (material != null) {
                    p.getInventory().addItem(new ItemStack(material, Math.max(1, amount)));
                } else {
                    plugin.getLogger().warning("Invalid or unknown material in config: " + materialName);
                }
            } catch (Exception e) {
                plugin.getLogger().warning("Failed to give initial gear for config item '" + materialName + "': " + e.getMessage());
            }
        }
    }
    
    /**
     * 初期ポーション効果を付与
     */
    private void applyInitialEffects(Player p) {
        ConfigurationSection effects = plugin.getConfig().getConfigurationSection("effects");
        if (effects == null) return;
        for (String effectName : effects.getKeys(false)) {
            try {
                PotionEffectType type = PotionEffectType.getByName(effectName);
                if (type == null) {
                    // try uppercase variant
                    type = PotionEffectType.getByName(effectName.toUpperCase());
                }
                if (type == null) {
                    plugin.getLogger().warning("Unknown potion effect in config: " + effectName);
                    continue;
                }

                String value = effects.getString(effectName, "60");
                int durationTicks;

                if (value.equalsIgnoreCase("infinite")) {
                    // avoid Integer.MAX_VALUE; use a very large value (ticks)
                    durationTicks = 2_000_000;
                } else {
                    try {
                        durationTicks = Integer.parseInt(value) * 20;
                    } catch (NumberFormatException nfe) {
                        plugin.getLogger().warning("Invalid effect duration for '" + effectName + "' in config: " + value + ", defaulting to 60s");
                        durationTicks = 60 * 20;
                    }
                }

                p.addPotionEffect(new PotionEffect(type, durationTicks, 0, false));
            } catch (Exception e) {
                plugin.getLogger().warning("Failed to apply effect from config: " + effectName + " -> " + e.getMessage());
            }
        }
    }
    
    /**
     * ロビーアイテムを作成
     */
    private ItemStack createLobbyItem(Material material, String name, String lore) {
        ItemStack item = new ItemStack(material, 1);
        ItemMeta meta = item.getItemMeta();
        
        if (meta != null) {
            meta.setDisplayName(name);
            meta.setLore(Collections.singletonList(ChatColor.GRAY + lore));
            meta.addItemFlags(ItemFlag.HIDE_ATTRIBUTES);
            item.setItemMeta(meta);
        }
        return item;
    }
}
